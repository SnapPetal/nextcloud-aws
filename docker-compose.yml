services:
  db:
    image: mariadb:10.11
    container_name: nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    volumes:
      - /var/lib/nextcloud/mysql:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    networks:
      - nextcloud-net
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  redis:
    image: redis:alpine
    container_name: nextcloud-redis
    restart: unless-stopped
    networks:
      - nextcloud-net

  app:
    build: .
    image: nextcloud-custom:latest
    container_name: nextcloud-app
    restart: unless-stopped
    ports:
      - "127.0.0.1:8080:80"
    volumes:
      - /var/lib/nextcloud/app:/var/www/html
      - ${DATA_PATH}/data:/var/www/html/data
    tmpfs:
      - /tmp:exec,size=4G
    environment:
      # Database Configuration (local MariaDB container)
      - MYSQL_HOST=db
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}

      # Redis Configuration
      - REDIS_HOST=redis

      # Nextcloud Configuration
      - NEXTCLOUD_TRUSTED_DOMAINS=${DOMAIN}
      - TRUSTED_PROXIES=10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
      - OVERWRITEHOST=${DOMAIN}
      - OVERWRITEPROTOCOL=https
      - OVERWRITECLIURL=https://${DOMAIN}
      - APACHE_DISABLE_REWRITE_IP=1

      # Performance tuning (optimized for 8GB RAM / 2 vCPU instance)
      - PHP_MEMORY_LIMIT=4G
      - PHP_UPLOAD_LIMIT=10G
      - APACHE_BODY_LIMIT=10737418240

      # Opcache settings for better PHP performance
      - PHP_OPCACHE_ENABLE=1
      - PHP_OPCACHE_MEMORY_CONSUMPTION=512
      - PHP_OPCACHE_MAX_ACCELERATED_FILES=10000
      - PHP_OPCACHE_REVALIDATE_FREQ=2
    depends_on:
      - db
      - redis
    networks:
      - nextcloud-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  nextcloud-net:
    driver: bridge
